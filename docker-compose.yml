# Docker Compose 配置 - MCP 服务器 (FastMCP 2.0 HTTP 模式)
# 
# 使用方式：
# docker compose up -d
#
# FastMCP 2.0 新特性：
# - 支持 HTTP 模式，可通过端口访问
# - 支持多种传输协议 (stdio, http, sse)
# - 纯 FastMCP 2.0 架构，移除原始 MCP SDK 依赖
#
# 配置说明：
# - 在 .env 文件中配置微信公众号相关环境变量（WECHAT_APP_ID, WECHAT_APP_SECRET）
# - 通过 MCP_TRANSPORT 环境变量选择传输模式：stdio(默认)、http、sse
# - HTTP 模式下服务器运行在端口 ${MCP_PORT:-3003}
# - 数据目录（data/）会持久化到本地
# - 健康检查确保服务可用性

services:
  # MCP 服务器
  wechat-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wechat_official_account_mcp
    # yefeng9758/wechat-official:latest
    image: wechat_official_account_mcp:latest
    restart: unless-stopped
    env_file:
      - .env  # 明确指定加载.env文件
    ports:
      - "${MCP_PORT:-3003}:${MCP_PORT:-3003}"  # HTTP 模式端口映射
      - "${WECHAT_MSG_SERVER_PORT:-80}:${WECHAT_MSG_SERVER_PORT:-80}"  # 微信web端口映射
    volumes:
      - ./data:/app/data  # 持久化数据
      - ./logs:/app/logs  # 日志文件
    environment:
      # 其他配置
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - TZ=Asia/Shanghai  # 设置上海时区
    
    # 健康检查
    # healthcheck:
    #   test: ["CMD", "python", "-c", "import httpx, os; httpx.get(f'http://localhost:{os.environ.get(\"MCP_PORT\", 3003)}/mcp', timeout=5)"]
    #   interval: 60s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s
    
    networks:
      - mcp-network

# 网络配置
networks:
  mcp-network:
    driver: bridge