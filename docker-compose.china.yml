# 适用于中国网络环境的 Docker Compose 配置
# 使用国内镜像源和优化的构建配置

services:
  # 微信公众号消息接收服务器
  wechat-server:
    build:
      context: .
      dockerfile: Dockerfile.china
    container_name: wechat_message_server
    restart: unless-stopped
    ports:
      - "${WECHAT_SERVER_PORT:-8000}:8000"
    volumes:
      - ./data:/app/data  # 持久化数据（SQLite 数据库）
      - .:/app  # 开发模式：挂载代码目录（生产环境建议移除）
    environment:
      - WECHAT_APP_ID=${WECHAT_APP_ID:-}
      - WECHAT_APP_SECRET=${WECHAT_APP_SECRET:-}
      - WECHAT_TOKEN=${WECHAT_TOKEN:-}
      - WECHAT_ENCODING_AES_KEY=${WECHAT_ENCODING_AES_KEY:-}
      - WECHAT_SERVER_PORT=8000
      - WECHAT_SERVER_HOST=0.0.0.0
      - WECHAT_API_PROXY=${WECHAT_API_PROXY:-api.weixin.qq.com}
      - WECHAT_API_TIMEOUT=${WECHAT_API_TIMEOUT:-30}
    command: python api/wechat_server.py
    networks:
      - wechat_network
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import requests; requests.get(\"http://localhost:8000/wechat\", params={\"signature\":\"test\",\"timestamp\":\"123\",\"nonce\":\"test\",\"echostr\":\"test\"}, timeout=5)' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  wechat_network:
    driver: bridge

volumes:
  wechat_data:
    driver: local

